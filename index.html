<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div id="container"></div>

<div>
    <h1>googlepay_payment_data</h1>
    <p>This value is returned from Google Pay and has not undergone processing by Collect.js or NMI.</p>
    <button onclick="copyToClipboard()">Copy to Clipboard</button>
    <code>
        <pre id="response">
            (Complete a Google Pay transaction)
        </pre>
    </code>

    <h1>Direct Post Response</h1>
    <code>
        <pre id="response2">
            (Complete a Google Pay transaction)
        </pre>
    </code>
</div>

<script>
    function copyToClipboard() {
        const codeContainer = document.querySelector('#response');

        if (document.body.createTextRange) {
            const range = document.body.createTextRange();
            range.moveToElementText(codeContainer);
            range.select();
        } else if (window.getSelection) {
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(codeContainer);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        document.execCommand('copy');
    }
</script>


<script>
    /**
      * An initialized google.payments.api.PaymentsClient object or null if not yet set
      *
      * @see {@link getGooglePaymentsClient}
      */
    let paymentsClient = null;

    /**
      * Return an active PaymentsClient or initialize
      *
      * @see {@link https://developers.google.com/pay/api/web/reference/client#PaymentsClient|PaymentsClient constructor}
      * @returns {google.payments.api.PaymentsClient} Google Pay API client
      */
    function getGooglePaymentsClient() {
        if ( paymentsClient === null ) {
            paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
        }
        return paymentsClient;
    }

    /**
      * Initialize Google PaymentsClient after Google-hosted JavaScript has loaded
      *
      * Display a Google Pay payment button after confirmation of the viewer's
      * ability to pay.
      */
    function onGooglePayLoaded() {
        const paymentsClient = getGooglePaymentsClient();
        paymentsClient.isReadyToPay({
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [
                {
                    type: 'CARD',
                    parameters: {
                        allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"],
                        allowedCardNetworks: ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"]
                    }
                }
            ]
        })
            .then(function(response) {
                if (response.result) {
                    // prefetchGooglePaymentData();
                    addGooglePayButton();
                }
            })
            .catch(function(err) {
                // show error in developer console for debugging
                console.error(err);
            });
    }

    /**
      * Add a Google Pay purchase button alongside an existing checkout button
      *
      * @see {@link https://developers.google.com/pay/api/web/reference/request-objects#ButtonOptions|Button options}
      * @see {@link https://developers.google.com/pay/api/web/guides/brand-guidelines|Google Pay brand guidelines}
      */
    function addGooglePayButton() {
        const paymentsClient = getGooglePaymentsClient();
        const button =
            paymentsClient.createButton({onClick: onGooglePaymentButtonClicked});
        document.getElementById('container').appendChild(button);
    }

    /**
      * Prefetch payment data to improve performance
      *
      * @see {@link https://developers.google.com/pay/api/web/reference/client#prefetchPaymentData|prefetchPaymentData()}
      */
    // function prefetchGooglePaymentData() {
    //     return {
    //         apiVersion: 2,
    //         apiVersionMinor: 0,
    //         allowedPaymentMethods: [{
    //             type: 'CARD',
    //             parameters: {
    //                 allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"],
    //                 allowedCardNetworks: ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"]
    //             },
    //             tokenizationSpecification: {
    //                 type: 'PAYMENT_GATEWAY',
    //                 parameters: {
    //                     'gateway': 'creditcall',
    //                     'gatewayMerchantId': 'example'
    //                 }
    //             }
    //         }],
    //         transactionInfo: {
    //             totalPriceStatus: 'NOT_CURRENTLY_KNOWN',
    //             currencyCode: 'USD'
    //         },
    //         merchantInfo: {
    //             // @todo a merchant ID is available for a production environment after approval by Google
    //             // See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
    //             // merchantId: '01234567890123456789',
    //             merchantName: 'Example Merchant'
    //         }
    //     };
    //     const paymentsClient = getGooglePaymentsClient();
    //     paymentsClient.prefetchPaymentData(paymentDataRequest);
    // }

    /**
      * Show Google Pay payment sheet when Google Pay payment button is clicked
      */
    function onGooglePaymentButtonClicked() {
        const paymentDataRequest = {
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [{
                type: 'CARD',
                parameters: {
                    allowedAuthMethods: ["CRYPTOGRAM_3DS"],
                    allowedCardNetworks: ["AMEX", "DISCOVER", "INTERAC", "JCB", "MASTERCARD", "VISA"]
                },
                tokenizationSpecification: {
                    type: 'PAYMENT_GATEWAY',
                    parameters: {
                        'gateway': 'creditcall',
                        'gatewayMerchantId': '1'
                    }
                }
            }],
            transactionInfo: {
                countryCode: 'US',
                currencyCode: 'USD',
                totalPriceStatus: 'FINAL',
                // set to cart total
                totalPrice: '1.00'
            },
            merchantInfo: {
                // @todo a merchant ID is available for a production environment after approval by Google
                // See {@link https://developers.google.com/pay/api/web/guides/test-and-deploy/integration-checklist|Integration checklist}
                // merchantId: '01234567890123456789',
                merchantName: 'Example Merchant'
            },
            emailRequired: true
        }

        const paymentsClient = getGooglePaymentsClient();
        paymentsClient.loadPaymentData(paymentDataRequest)
            .then(function(paymentData) {
                // handle the response
                updateResponse('(Waiting for response from Direct Post API)')
                processPayment(paymentData);
            })
            .catch(function(err) {
                // show error in developer console for debugging
                console.error(err);
            });
    }

    function updateResponse(text) {
        document.getElementById('response2').innerHTML = text;
    }

    function updatePaymentToken(text) {
        document.getElementById('response').innerHTML = text;
    }

    /**
      * Process payment data returned by the Google Pay API
      *
      * @param {object} paymentData response from Google Pay API after user approves payment
      * @see {@link https://developers.google.com/pay/api/web/reference/response-objects#PaymentData|PaymentData object reference}
      */
    function processPayment(paymentData) {
        // show returned data in developer console for debugging
        console.log(paymentData);
        updatePaymentToken(paymentData.paymentMethodData.tokenizationData.token);
//         fetch('google_pay_endpoint.php', {
//             method: 'POST', // *GET, POST, PUT, DELETE, etc.
//             headers: {
//                 'Content-Type': 'application/json'
//                 // 'Content-Type': 'application/x-www-form-urlencoded',
//             },
//             body: JSON.stringify({
//                token: paymentData.paymentMethodData.tokenizationData.token
//             }) // body data type must match "Content-Type" header
//         })
//             .then((response) => {
//                 return response.json();
//             })
//             .then((text) => {
//                 updateResponse(JSON.stringify(text, null, 2))
//             });
    }
</script>

<script async
          src="https://pay.google.com/gp/p/js/pay.js"
          onload="onGooglePayLoaded()">
</script>
    </body>
</html>



